<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Topologies Visualizer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-row">
                <h1>Team Topologies Visualizer</h1>
                <div class="header-actions">
                    <div class="snapshot-controls-group">
                        <button id="createSnapshotBtn" class="btn" style="display: none;">üì∏ Create Snapshot</button>
                        <button id="timelineBtn" class="btn" style="display: none;">üìú Snapshots & Timeline</button>
                    </div>
                    <button id="exportSVGBtn" class="btn">üì• Export SVG</button>
                    <button id="validateBtn" class="btn">‚úì Validate</button>
                    <button id="keyboardShortcutsBtn" class="btn" title="Keyboard Shortcuts">?</button>
                    <button id="refreshBtn" class="btn">üîÑ Refresh</button>
                </div>
            </div>
            <div class="header-row controls-row">
                <div class="controls-left">
                    <div class="view-selector">
                        <label class="radio-label">
                            <input type="radio" name="view" value="current" id="viewCurrent">
                            <span>Pre-TT</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="view" value="tt" id="viewTT" checked>
                            <span>TT Design</span>
                        </label>
                    </div>
                    <div class="perspective-selector" id="perspectiveSelector" style="display: none;">
                        <span class="inline-divider"></span>
                        <label class="radio-label">
                            <input type="radio" name="perspective" value="hierarchy" id="perspectiveHierarchy" checked>
                            <span>üìä Hierarchy</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="perspective" value="product-lines" id="perspectiveProductLines">
                            <span>üè≠ Product Lines</span>
                        </label>
                    </div>
                    <div class="view-options">
                        <label class="radio-label" id="showConnectionsLabel" style="display: none;">
                            <input type="checkbox" id="showConnections">
                            <span>Show Communication Lines</span>
                        </label>
                        <span class="inline-divider" id="connectionsCognitiveLoadDivider" style="display: none;"></span>
                        <label class="radio-label" id="showInteractionModesLabel" style="display: none;">
                            <input type="checkbox" id="showInteractionModes" checked>
                            <span>Show Interaction Modes</span>
                        </label>
                        <span class="inline-divider" id="modesCognitiveLoadDivider" style="display: none;"></span>
                        <label class="radio-label">
                            <input type="checkbox" id="showCognitiveLoad">
                            <span>üö¶ Cognitive Load</span>
                        </label>
                        <span class="inline-divider" id="cognitiveLoadBadgesDivider" style="display: none;"></span>
                        <label class="radio-label" id="teamTypeBadgesLabel" style="display: none;">
                            <input type="checkbox" id="showTeamTypeBadges">
                            <span>üè∑Ô∏è Type Badges</span>
                        </label>
                    </div>
                    <div id="groupingFilterContainer" class="filter-panel" style="display: none;">
                        <button id="filterToggleBtn" class="btn filter-toggle-btn">
                            <span>üîç Filters</span>
                            <span class="filter-count" id="filterCount"></span>
                        </button>
                        <div id="filterDropdown" class="filter-dropdown-panel">
                            <div class="filter-section">
                                <div class="filter-section-header">
                                    <strong>Value Streams</strong>
                                    <button class="filter-clear-btn" data-type="vs">Clear</button>
                                </div>
                                <div id="valueStreamFilters" class="filter-options"></div>
                            </div>
                            <div class="filter-section">
                                <div class="filter-section-header">
                                    <strong>Platform Groupings</strong>
                                    <button class="filter-clear-btn" data-type="pg">Clear</button>
                                </div>
                                <div id="platformGroupingFilters" class="filter-options"></div>
                            </div>
                            <div class="filter-section">
                                <div class="filter-section-header">
                                    <strong>Ungrouped Teams</strong>
                                </div>
                                <div id="ungroupedFilters" class="filter-options">
                                    <label class="filter-checkbox-label">
                                        <input type="checkbox" id="showUngroupedTeams" class="filter-checkbox" data-type="ungrouped">
                                        <span>Show Ungrouped Teams</span>
                                    </label>
                                </div>
                            </div>
                            <div class="filter-actions">
                                <button id="clearAllFiltersBtn" class="btn btn-secondary">Clear All</button>
                                <button id="applyFiltersBtn" class="btn btn-primary">Apply</button>
                            </div>
                        </div>
                    </div>
                    <button id="autoAlignBtn" class="btn" style="display: none;">‚ö° Auto-align</button>
                    <button id="autoAlignTTBtn" class="btn" style="display: none;">‚ö° Auto-align</button>
                </div>
                <div class="zoom-controls">
                    <button id="zoomOutBtn" class="btn btn-icon" title="Zoom Out (Ctrl+-)">-</button>
                    <span id="zoomLevel" class="zoom-level">100%</span>
                    <button id="zoomInBtn" class="btn btn-icon" title="Zoom In (Ctrl++)">+</button>
                    <button id="fitViewBtn" class="btn btn-icon" title="Fit to View (Ctrl+0)">‚ä°</button>
                </div>
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <h3>Teams</h3>
                <div class="search-container">
                    <input type="text" id="teamSearch" placeholder="üîç Search teams..." class="search-input">
                </div>
                <div id="teamList" class="team-list"></div>
                
                <div class="legend">
                    <h4>Team Types</h4>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #4A90E2;"></span>
                        <span>Stream-aligned</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #7ED321;"></span>
                        <span>Platform</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #F5A623;"></span>
                        <span>Enabling</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #BD10E0;"></span>
                        <span>Complicated Subsystem</span>
                    </div>
                </div>
            </aside>

            <main class="canvas-area">
                <canvas id="teamCanvas"></canvas>
                <!-- Hidden element for E2E testing - mirrors canvas state -->
                <div id="canvasTestState" style="display: none;" 
                     data-total-teams="0" 
                     data-filtered-teams="0"
                     data-active-filters=""
                     data-search-term=""
                     data-current-view=""></div>
            </main>
        </div>
    </div>

    <!-- Modal for adding/editing teams -->
    <div id="teamModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Add Team</h2>
            <form id="teamForm">
                <div class="form-group">
                    <label for="teamName">Team Name</label>
                    <input type="text" id="teamName" required>
                </div>
                
                <div class="form-group">
                    <label for="teamType">Team Type</label>
                    <select id="teamType" required>
                        <option value="stream-aligned">Stream-aligned</option>
                        <option value="platform">Platform</option>
                        <option value="enabling">Enabling</option>
                        <option value="complicated-subsystem">Complicated Subsystem</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="teamDescription">Description</label>
                    <textarea id="teamDescription" rows="4"></textarea>
                </div>
                
                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn" id="cancelBtn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for team details -->
    <div id="detailModal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" id="detailModalClose">&times;</span>
            <div id="teamDetails">
                <div class="detail-header">
                    <h2 id="detailTeamName"></h2>
                    <span id="detailTeamType" class="team-badge"></span>
                </div>
                
                <div class="detail-section">
                    <div id="detailDescription" class="markdown-content"></div>
                </div>
                
                <div class="detail-grid">
                    <div class="detail-section">
                        <h3>Dependencies</h3>
                        <ul id="detailDependencies" class="detail-list"></ul>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Interaction Modes</h3>
                        <ul id="detailInteractions" class="detail-list"></ul>
                    </div>
                </div>
                
                <div class="detail-section" id="detailMetadataSection">
                    <h3>Metadata</h3>
                    <div id="detailMetadata" class="metadata-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Interaction Mode Info Modals -->
    <div id="interactionModeModal" class="modal">
        <div class="modal-content modal-medium">
            <span class="close" id="interactionModeModalClose">&times;</span>
            <div id="interactionModeContent"></div>
        </div>
    </div>

    <!-- Validation Report Modal -->
    <div id="validationModal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" id="validationModalClose">&times;</span>
            <h2>File Validation Report</h2>
            <div id="validationReport"></div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="keyboardShortcutsModal" class="modal">
        <div class="modal-content modal-medium">
            <span class="close" id="keyboardShortcutsModalClose">&times;</span>
            <h2>‚å®Ô∏è Keyboard Shortcuts</h2>
            <div class="shortcuts-grid">
                <div class="shortcut-group">
                    <h3>Canvas Navigation</h3>
                    <div class="shortcut-row">
                        <span class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>+</kbd></span>
                        <span class="shortcut-desc">Zoom in</span>
                    </div>
                    <div class="shortcut-row">
                        <span class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>-</kbd></span>
                        <span class="shortcut-desc">Zoom out</span>
                    </div>
                    <div class="shortcut-row">
                        <span class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>0</kbd></span>
                        <span class="shortcut-desc">Fit to view</span>
                    </div>
                    <div class="shortcut-row">
                        <span class="shortcut-keys">Mouse drag</span>
                        <span class="shortcut-desc">Pan canvas</span>
                    </div>
                </div>
                <div class="shortcut-group">
                    <h3>General</h3>
                    <div class="shortcut-row">
                        <span class="shortcut-keys"><kbd>Esc</kbd></span>
                        <span class="shortcut-desc">Close modal</span>
                    </div>
                    <div class="shortcut-row">
                        <span class="shortcut-keys"><kbd>?</kbd></span>
                        <span class="shortcut-desc">Show this help</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Snapshot Modal -->
    <div id="createSnapshotModal" class="modal">
        <div class="modal-content modal-medium">
            <span class="close" id="createSnapshotModalClose">&times;</span>
            <h2>üì∏ Create Snapshot</h2>
            <p>Capture the current TT Design state as a snapshot for tracking evolution over time.</p>
            <div id="snapshotPreview" style="padding: 10px; background: #f5f5f5; border-radius: 4px; margin: 15px 0;">
                Loading preview...
            </div>
            <form id="createSnapshotForm">
                <div class="form-group">
                    <label for="snapshotName">Snapshot Name *</label>
                    <input type="text" id="snapshotName" required placeholder="e.g., TT Design v1.0 - 2026-01-15">
                </div>
                <div class="form-group">
                    <label for="snapshotDescription">Description</label>
                    <textarea id="snapshotDescription" rows="3" placeholder="Optional: Describe what changed or why this snapshot matters"></textarea>
                </div>
                <div class="form-group">
                    <label for="snapshotAuthor">Author</label>
                    <input type="text" id="snapshotAuthor" placeholder="Your name or email">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelSnapshotBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Snapshot</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Timeline/Snapshot Browser Panel -->
    <div id="timelinePanel" class="timeline-panel" style="display: none;">
        <div class="timeline-header">
            <h3>üìú Snapshots & Timeline</h3>
            <button class="close-panel-btn" id="closeTimelineBtn">&times;</button>
        </div>
        <div class="timeline-actions">
            <button id="compareSnapshotsBtn" class="btn btn-primary" style="display: none;">üîÑ Compare Snapshots</button>
        </div>
        <div class="timeline-content">
            <div class="snapshot-list" id="snapshotList">
                Loading snapshots...
            </div>
        </div>
    </div>

    <!-- Snapshot Comparison Modal -->
    <div id="compareSnapshotsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîÑ Compare Snapshots</h2>
                <span class="close-btn" id="compareSnapshotsModalClose">&times;</span>
            </div>
            
            <div class="compare-form">
                <div class="form-group">
                    <label for="beforeSnapshot">Before (earlier snapshot):</label>
                    <select id="beforeSnapshot" class="form-control" required>
                        <option value="">Select snapshot...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="afterSnapshot">After (later snapshot):</label>
                    <select id="afterSnapshot" class="form-control" required>
                        <option value="">Select snapshot...</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button id="cancelCompareBtn" class="btn btn-secondary">Cancel</button>
                    <button id="compareBtn" class="btn btn-primary">üîÑ Compare</button>
                </div>
            </div>
            
            <div id="comparisonResults" style="display: none;">
                <!-- Comparison results will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Side-by-Side Comparison View Modal -->
    <div id="comparisonViewModal" class="comparison-view-modal" style="display: none;">
        <div class="comparison-view-container">
            <div class="comparison-view-header">
                <div class="comparison-view-title">
                    <span class="comparison-icon">üîÑ</span>
                    <div class="comparison-names">
                        <span id="comparisonBeforeName" class="snapshot-name before"></span>
                        <span class="arrow">‚Üí</span>
                        <span id="comparisonAfterName" class="snapshot-name after"></span>
                    </div>
                </div>
                <button class="close-btn" id="closeComparisonViewBtn">&times;</button>
            </div>
            
            <div class="comparison-view-controls">
                <label class="comparison-control-label">
                    <input type="checkbox" id="showGroupingsComparison" checked>
                    <span>Show Groupings</span>
                </label>
                <label class="comparison-control-label">
                    <input type="checkbox" id="showInteractionsComparison" checked>
                    <span>Show Interactions</span>
                </label>
                <label class="comparison-control-label">
                    <input type="checkbox" id="showBadgesComparison" checked>
                    <span>Show Change Badges</span>
                </label>
            </div>
            
            <div class="comparison-view-content">
                <div class="comparison-canvas-panels">
                    <div class="comparison-panel before">
                        <div class="panel-header">
                            <h3>üì∏ Before</h3>
                            <span class="snapshot-date" id="comparisonBeforeDate"></span>
                        </div>
                        <div class="canvas-container">
                            <canvas id="comparisonBeforeCanvas"></canvas>
                            <div class="canvas-controls">
                                <button class="canvas-control-btn" id="beforeZoomIn" title="Zoom In">üîç+</button>
                                <button class="canvas-control-btn" id="beforeZoomOut" title="Zoom Out">üîç‚àí</button>
                                <button class="canvas-control-btn" id="beforeResetView" title="Reset View">‚ü≤</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="comparison-panel after">
                        <div class="panel-header">
                            <h3>üì∏ After</h3>
                            <span class="snapshot-date" id="comparisonAfterDate"></span>
                        </div>
                        <div class="canvas-container">
                            <canvas id="comparisonAfterCanvas"></canvas>
                            <div class="canvas-controls">
                                <button class="canvas-control-btn" id="afterZoomIn" title="Zoom In">üîç+</button>
                                <button class="canvas-control-btn" id="afterZoomOut" title="Zoom Out">üîç‚àí</button>
                                <button class="canvas-control-btn" id="afterResetView" title="Reset View">‚ü≤</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="comparison-details-panel">
                    <h3>Changes Summary</h3>
                    <div id="comparisonChangesSummary" class="changes-summary-sidebar">
                        <!-- Changes will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Snapshot View Banner -->
    <div id="snapshotBanner" class="snapshot-banner" style="display: none;">
        <div class="banner-content">
            <span class="banner-icon">üì∏</span>
            <span class="banner-text">
                <strong>Viewing Snapshot (READ-ONLY):</strong> <span id="snapshotBannerName"></span>
                <small id="snapshotBannerDate"></small>
            </span>
            <button class="btn btn-sm btn-primary" id="returnToLiveBtn">Return to Live View</button>
        </div>
    </div>

    <script type="module" src="app.js"></script>
</body>
</html>
